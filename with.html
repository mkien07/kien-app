<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Qu·∫£n l√Ω ƒë∆°n r√∫t</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .status-pending { color:#f59e0b; font-weight:600; }
    .status-approved { color:#10b981; font-weight:600; }
    .status-canceled { color:#ef4444; font-weight:600; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:50; }
    .modal.show { display:flex; }
  </style>
</head>
<body class="bg-gray-100 p-4">

  <div class="max-w-7xl mx-auto bg-white rounded-lg shadow p-4">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">üìã Danh s√°ch ƒë∆°n r√∫t</h2>
      <input id="search" type="text" placeholder="T√¨m UID..." class="border rounded px-3 py-1 w-64">
    </div>

    <div class="flex space-x-2 mb-3">
      <button class="filter bg-blue-500 text-white px-3 py-1 rounded" data-status="">T·∫•t c·∫£</button>
      <button class="filter bg-yellow-400 px-3 py-1 rounded" data-status="pending">Pending</button>
      <button class="filter bg-green-500 text-white px-3 py-1 rounded" data-status="approved">Approved</button>
      <button class="filter bg-red-500 text-white px-3 py-1 rounded" data-status="canceled">Canceled</button>
    </div>

    <div id="stats" class="mb-3 text-sm text-gray-600"></div>

    <div class="overflow-x-auto">
      <table class="w-full border text-sm">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-2 py-1">UID</th>
            <th class="px-2 py-1">Ph∆∞∆°ng th·ª©c</th>
            <th class="px-2 py-1">S·ªë ti·ªÅn</th>
            <th class="px-2 py-1">Th√¥ng tin</th>
            <th class="px-2 py-1">Th·ªùi gian</th>
            <th class="px-2 py-1">Tr·∫°ng th√°i</th>
            <th class="px-2 py-1">H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody id="withdraw-table">
          <tr><td colspan="7" class="p-2 text-center">ƒêang t·∫£i...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal th√¥ng b√°o -->
  <div id="notifyModal" class="modal">
    <div class="bg-white rounded-lg p-6 w-80 text-center">
      <p id="notifyText" class="mb-4 text-lg font-medium"></p>
      <button onclick="closeNotify()" class="bg-blue-500 text-white px-4 py-1 rounded">ƒê√≥ng</button>
    </div>
  </div>

  <!-- Modal l·ªãch s·ª≠ r√∫t -->
  <div id="historyModal" class="modal">
    <div class="bg-white rounded-lg p-4 max-w-lg w-full max-h-[80vh] overflow-auto">
      <div class="flex justify-between items-center mb-2">
        <h3 class="font-bold">L·ªãch s·ª≠ r√∫t ti·ªÅn</h3>
        <button onclick="closeHistory()" class="text-red-500">‚úï</button>
      </div>
      <div id="historyContent" class="text-sm"></div>
    </div>
  </div>

<script>
let allData = [];
let currentFilter = '';

async function loadWithdraws() {
  const res = await fetch('/admin/withdraws');
  const tbody = document.getElementById('withdraw-table');
  if (!res.ok) {
    tbody.innerHTML = '<tr><td colspan="7" class="p-2 text-center">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</td></tr>';
    return;
  }
  allData = await res.json();
  renderTable();
  updateStats();
}

function renderTable() {
  const searchVal = document.getElementById('search').value.toLowerCase();
  const tbody = document.getElementById('withdraw-table');
  let data = allData;

  if (currentFilter) {
    data = data.filter(w => w.status === currentFilter);
  }

  if (searchVal) {
    data = data.filter(w => w.userId.toLowerCase().includes(searchVal));
  }

  if (!data.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="p-2 text-center">Kh√¥ng c√≥ ƒë∆°n n√†o</td></tr>';
    return;
  }

  tbody.innerHTML = '';
  data.forEach(w => {
    const info = w.method === 'bank'
      ? `${w.accountName} - ${w.accountNumber} (${w.bankName})`
      : `${w.usdtAddress} (${w.network})`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="text-blue-600 cursor-pointer" onclick="showHistory('${w.userId}')">${w.userId}</td>
      <td>${w.method.toUpperCase()}</td>
      <td>${Number(w.amount).toLocaleString()}‚Ç´</td>
      <td>${info}</td>
      <td>${new Date(w.createdAt).toLocaleString()}</td>
      <td class="status-${w.status}">${w.status}</td>
      <td>
        ${w.status === 'pending'
          ? `<button class="bg-green-500 text-white px-2 py-1 rounded" onclick="approve('${w._id}')">Duy·ªát</button>
             <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="cancel('${w._id}')">H·ªßy</button>`
          : '‚Äî'}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function updateStats() {
  const total = allData.length;
  const pending = allData.filter(x=>x.status==='pending').length;
  const approved = allData.filter(x=>x.status==='approved').length;
  const sum = allData.reduce((a,b)=>a+Number(b.amount),0);
  document.getElementById('stats').innerText =
    `T·ªïng: ${total} ƒë∆°n | Pending: ${pending} | Approved: ${approved} | T·ªïng s·ªë ti·ªÅn: ${sum.toLocaleString()}‚Ç´`;
}

async function approve(id) {
  const res = await fetch(`/admin/withdraw/${id}/approve`, { method:'POST' });
  if (res.ok) {
    showNotify('‚úÖ ƒê√£ duy·ªát ƒë∆°n');
    loadWithdraws();
  } else showNotify('‚ùå L·ªói duy·ªát ƒë∆°n');
}

async function cancel(id) {
  const res = await fetch(`/admin/withdraw/${id}/cancel`, { method:'POST' });
  if (res.ok) {
    showNotify('‚úÖ ƒê√£ h·ªßy ƒë∆°n v√† ho√†n ti·ªÅn');
    loadWithdraws();
  } else showNotify('‚ùå L·ªói h·ªßy ƒë∆°n');
}

function showNotify(msg) {
  document.getElementById('notifyText').innerText = msg;
  document.getElementById('notifyModal').classList.add('show');
}
function closeNotify() {
  document.getElementById('notifyModal').classList.remove('show');
}

async function showHistory(userId) {
  const modal = document.getElementById('historyModal');
  const content = document.getElementById('historyContent');
  modal.classList.add('show');
  content.innerHTML = 'ƒêang t·∫£i...';

  const res = await fetch(`/admin/withdraws?userId=${userId}`);
  const list = await res.json();

  if (!list.length) {
    content.innerHTML = '<p>Kh√¥ng c√≥ l·ªãch s·ª≠ r√∫t ti·ªÅn</p>';
    return;
  }

  const total = list.reduce((sum, x) => sum + Number(x.amount), 0);
  const pending = list.filter(x=>x.status==='pending').length;
  const approved = list.filter(x=>x.status==='approved').length;
  const canceled = list.filter(x=>x.status==='canceled').length;

  const summary = `
    <div class="mb-2 p-2 bg-gray-100 rounded">
      <b>T·ªïng s·ªë ƒë∆°n:</b> ${list.length} | 
      <b>Pending:</b> ${pending} | 
      <b>Approved:</b> ${approved} | 
      <b>Canceled:</b> ${canceled} |
      <b>T·ªïng ti·ªÅn:</b> ${total.toLocaleString()}‚Ç´
    </div>
  `;

  content.innerHTML = summary + list.map(w => `
    <div class="border-b py-1">
      <b>${Number(w.amount).toLocaleString()}‚Ç´</b> - ${w.status} - ${new Date(w.createdAt).toLocaleString()}
    </div>
  `).join('');
}

function closeHistory() {
  document.getElementById('historyModal').classList.remove('show');
}

document.getElementById('search').addEventListener('input', renderTable);
document.querySelectorAll('.filter').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    currentFilter = btn.dataset.status;
    renderTable();
  });
});

loadWithdraws();
setInterval(loadWithdraws, 30000);
</script>
</body>
</html>
